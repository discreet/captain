#!/usr/bin/env ruby
#
# This script takes an input for the directory to validate CFTs in. This
# directory is relative to the root of the project. If changes are detected it
# will execture the aws cli command for validating CFTs. If all validation
# passes it will exit 0. If no changes are detected it will exit 0
#
require 'English'
require_relative '../lib/input'
require_relative '../lib/changes'
require_relative '../lib/success'
require_relative '../lib/test'
require_relative '../lib/scriptdir'

@test = 'CFT validation'

Dir.chdir(Script.dir)
@appDir = Input.getDir(@test)

Dir.chdir('../../') do
  case Changes.findChanges(@appDir, @test)
  when true
    Dir.chdir(@appDir) do
      print 'specify the profile for authentication: '
      STDIN.reopen('/dev/tty')
      @profile = $stdin.gets.chomp

      @files = Dir.entries('.').reject { |f| File.directory? f }\
                  .select { |i| i =~ /\.json|\.yaml|\.yml/ }

      @files.each do |file|
        Test.cft(@profile, file)
        break if $CHILD_STATUS.exitstatus != 0
      end
      Success.success(@test) if $CHILD_STATUS.exitstatus.zero?
      exit $CHILD_STATUS.exitstatus
    end
  else
    exit 0
  end
end
